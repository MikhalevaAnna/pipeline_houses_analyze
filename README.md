# Проанализировать информацию о домах

Есть **csv** файл, расположенный по ссылке. Скачивайте по ссылке: https://disk.yandex.ru/d/PBWn9vwv_xSk8A <br>
Его нужно будет положить в проекте **pipeline_houses_analyze** папку **sample_data**. <br>
В эту же папку после запуска пайплайна будут создаваться графики как результаты выполнения 5, 6 и 7 пунктов. <br>
Размер распакованного файла около 300 Мб. Количество строк - 590708 строк.

## Данные в файле:
**house_id** - `ID объекта` - (например, 590707) <br>
**latitude**, **longitude** - `Координаты` - (Широта, Долгота) (например, 55.060199, 32.695577) <br>
**maintenance_year** - `Год постройки` - (например, 1953.0) <br>
**square** - `Площадь` - (например, 585.60) <br>
**population** - `Количество этажей` - (например, 18) <br>
**region** - `Область`  - (например, Смоленская область) <br> 
**locality_name** - `Город` - (например, Ярцево) <br>
**address** - `Адрес` (например, "ул. Братьев Шаршановых, д. 61") <br>
**full_address** - `Полный адрес` (например,  "Ставропольский край, р-н. Александровский, с. Александровское, ул. Калинина, д. 25") <br>
**communal_service_id** - `ID ЖКУ` (напроимер, 30619.0) <br>
**description** - `Описание объекта` - (например, "Жилой дом в Ярцево, по адресу ул. Братьев Шаршановых, д. 61, 1953 года постройки, под управлением ТСЖ «Шаршановых».") <br>

## Выполнение задания:

1. Загружаем файл данных в **DataFrame PySpark**. Обязательно выводим количество строк. <br>

2. Убедимся, что данные корректно прочитаны (правильный формат, отсутствие пустых строк). <br>

3. Преобразуем текстовые и числовые поля в соответствующие типы данных (например, дата, число). <br>
 
4. Вычислим средний и медианный год постройки зданий. <br>

5. Определим топ-10 областей и городов с наибольшим количеством объектов. <br>

6. Найдем здания с максимальной и минимальной площадью в рамках каждой области. <br>

7. Определим количество зданий по десятилетиям (например, сколько зданий построено в 1950-х, 1960-х и т.д.). <br>

## С данными поработали, проанализировали, теперь можно их и в БД положить. 

8. Создадим схему таблицы в **ClickHouse**, которая будет соответствовать структуре наших данных в **airflow**. <br>

9. Настроим соединение с **ClickHouse** из скрипта в **airflow**. <br>

10. Загрузим обработанные данные из **DataFrame** в таблицу в **ClickHouse** в **airflow**. <br>

11. Выполним **SQL** скрипт в **Python**, который выведет топ 25 домов, у которых площадь больше 60 кв.м в **airflow**. <br>

Все операции по созданию таблиц, обработке, миграции данных происходят внутри **Airflow**.


### Просмотр данных через DBeaver:
В **DBeaver**, после успешной работы пайплайна, можно посмотреть полученную таблицу `houses_data` в **ClickHouse**.


#### Для подключение к **ClickHouse** используются следующие параметры:
```
    Хост: localhost
    Порт: 8123
```
#### Команды для запуска проекта:
```bash
    git clone https://github.com/MikhalevaAnna/pipeline_houses_analyze.git
    cd pipeline_houses_analyze
    docker build -t airflow-with-java-c .
    docker-compose up --build
```
    
- Далее идем по адресу - **http://localhost:8080**
- Логин и пароль - **airflow**.

## Результат выполнения DAG:
1. Начальная структура датафрейма:
```
 |-- house_id: integer (nullable = true)
 |-- latitude: double (nullable = true)
 |-- longitude: double (nullable = true)
 |-- maintenance_year: string (nullable = true)
 |-- square: string (nullable = true)
 |-- population: string (nullable = true)
 |-- region: string (nullable = true)
 |-- locality_name: string (nullable = true)
 |-- address: string (nullable = true)
 |-- full_address: string (nullable = true)
 |-- communal_service_id: string (nullable = true)
 |-- description: string (nullable = true)

+--------+------------------+------------------+----------------+--------+----------+-------------------+--------------------+--------------------+--------------------+-------------------+--------------------+
|house_id|          latitude|         longitude|maintenance_year|  square|population|             region|       locality_name|             address|        full_address|communal_service_id|         description|
+--------+------------------+------------------+----------------+--------+----------+-------------------+--------------------+--------------------+--------------------+-------------------+--------------------+
|       1|         44.707617|         43.006476|            1974|2 661.10|        89|Ставропольский край|село Александровское|с. Александровско...|Ставропольский кр...|                1.0|Жилой дом в , по ...|
|       2|44.706720000000004|         43.005281|            1989|3 111.10|       115|Ставропольский край|село Александровское|с. Александровско...|Ставропольский кр...|                1.0|Жилой дом в , по ...|
|       3|         44.708302|43.006665000000005|            1977|2 896.04|        89|Ставропольский край|село Александровское|с. Александровско...|Ставропольский кр...|                1.0|Жилой дом в , по ...|
|       4|44.711946999999995|          42.97358|            null|  620.00|        30|Ставропольский край|село Александровское|с. Александровско...|Ставропольский кр...|                1.0|Жилой дом в , по ...|
|       5|44.711946999999995|          42.97358|            1978|1 061.92|        26|Ставропольский край|село Александровское|с. Александровско...|Ставропольский кр...|                1.0|Жилой дом в , по ...|
|       6|         44.707751|         43.005515|            1978|2 688.70|       105|Ставропольский край|село Александровское|с. Александровско...|Ставропольский кр...|                2.0|Жилой дом в , по ...|
|       7|44.711946999999995|          42.97358|            1973|  854.90|        40|Ставропольский край|село Александровское|с. Александровско...|Ставропольский кр...|                3.0|Жилой дом в , по ...|
|       8|44.723622999999996|         42.996864|            1978|  924.40|        31|Ставропольский край|село Александровское|с. Александровско...|Ставропольский кр...|                4.0|Жилой дом в , по ...|
|       9|44.721765999999995|          43.02013|            1974|1 011.30|        38|Ставропольский край|село Александровское|с. Александровско...|Ставропольский кр...|                5.0|Жилой дом в , по ...|
|      10|         44.710557|         43.000278|            1963|  621.21|        20|Ставропольский край|село Александровское|с. Александровско...|Ставропольский кр...|                6.0|Жилой дом в , по ...|
+--------+------------------+------------------+----------------+--------+----------+-------------------+--------------------+--------------------+--------------------+-------------------+--------------------+
only showing top 10 rows
```
Количество записей в датафрейме всего: 590707. <br>
Количество записей в датафрейме всего без дубляжа и пустых записей: 440260. <br>
Поле maintenance_year для примера: <br>
```
+----------------+----------------------+
|maintenance_year|count_maintenance_year|
+----------------+----------------------+
|          1960.0|                    33|
|          1984.0|                    27|
|          1959.0|                    26|
|          1955.0|                    24|
|          1958.0|                    23|
|          1972.0|                    23|
|          1954.0|                    22|
|          1956.0|                    22|
|          1957.0|                    21|
|          1983.0|                    19|
|          1989.0|                    19|
|          1980.0|                    19|
|          1986.0|                    19|
|          1982.0|                    18|
|          1991.0|                    18|
|          1962.0|                    18|
|          1961.0|                    18|
|          1981.0|                    17|
|          1975.0|                    17|
|          1987.0|                    17|
+----------------+----------------------+
only showing top 20 rows
```
2. Количество записей в датафрейме, где площадь больше 1: 440212.
```
+-------------+------------+
|modify_square|count_square|
+-------------+------------+
|        84.00|         164|
|        96.00|         157|
|       140.00|         156|
|       112.00|         146|
|        98.00|         142|
|       108.00|         138|
|       120.00|         135|
|        60.00|         129|
|       110.00|         116|
|       126.00|         115|
|       128.00|         114|
|       125.00|         112|
|       104.00|         112|
|        90.00|         111|
|       100.00|         111|
|        92.00|         110|
|        94.00|         109|
|        82.00|         106|
|       150.00|         105|
|       132.00|         103|
+-------------+------------+
only showing top 20 rows
```
3. Структура с типами данных: <br>
```
 |-- house_id: integer (nullable = true)
 |-- latitude: float (nullable = true)
 |-- longitude: float (nullable = true)
 |-- maintenance_year: integer (nullable = true)
 |-- square: string (nullable = true)
 |-- population: short (nullable = true)
 |-- region: string (nullable = true)
 |-- locality_name: string (nullable = true)
 |-- address: string (nullable = true)
 |-- full_address: string (nullable = true)
 |-- communal_service_id: float (nullable = true)
 |-- description: string (nullable = true)
 |-- modify_square: float (nullable = true)
```
Количество записей в откорректированном датафрейме всего: 440212. 
```
+--------+---------+---------+----------------+--------+----------+-------------------+--------------------+--------------------+--------------------+-------------------+--------------------+-------------+
|house_id| latitude|longitude|maintenance_year|  square|population|             region|       locality_name|             address|        full_address|communal_service_id|         description|modify_square|
+--------+---------+---------+----------------+--------+----------+-------------------+--------------------+--------------------+--------------------+-------------------+--------------------+-------------+
|      60|44.148598|43.473896|            1968|  997.00|        50|Ставропольский край|          Георгиевск| ул. Горийская, д. 6|Ставропольский кр...|               12.0|Жилой дом в Георг...|        997.0|
|      81|44.123013|43.636555|            1976|  872.10|        42|Ставропольский край|поселок Нижнезоль...|п. Нижнезольский,...|Ставропольский кр...|               14.0|Жилой дом в , по ...|        872.1|
|     260|44.628216| 44.13441|            1979|7 354.40|       167|Ставропольский край|          Буденновск|      мкр. 8-й, д. 4|Ставропольский кр...|               23.0|Жилой дом в Буден...|       7354.4|
|     440| 44.15409|43.474525|            1975|1 195.20|        52|Ставропольский край|          Георгиевск|ул. Лермонтова, д...|Ставропольский кр...|               48.0|Жилой дом в Георг...|       1195.2|
|     936| 44.63441|41.948772|            1979|3 105.30|       112|Ставропольский край|        Невинномысск|ул. 3 Интернацион...|Ставропольский кр...|              119.0|Жилой дом в Невин...|       3105.3|
+--------+---------+---------+----------------+--------+----------+-------------------+--------------------+--------------------+--------------------+-------------------+--------------------+-------------+
only showing top 5 rows
```
4.1. Средний год постройки домов:
```
+--------------------+
|avg_maintenance_year|
+--------------------+
|                1970|
+--------------------+
```
4.2. Средний медианный год постройки домов:
```
+-----------------------+
|median_maintenance_year|
+-----------------------+
|                   1971|
+-----------------------+
```
5.1. Топ-10 областей с наибольшим количеством объектов:
```
+--------------------+----------+
|              region|cnt_houses|
+--------------------+----------+
|  Московская область|     25461|
|              Москва|     23486|
|Свердловская область|     20630|
|Республика Татарстан|     14137|
|Нижегородская обл...|     13830|
|   Красноярский край|     13791|
| Кемеровская область|     12250|
|  Ростовская область|     11493|
|   Самарская область|     10922|
|   Иркутская область|     10525|
+--------------------+----------+
only showing top 10 rows
```
5.2. Топ-10 городов с наибольшим количеством объектов:
```
+---------------+----------+
|  locality_name|cnt_houses|
+---------------+----------+
|         Москва|     23405|
|         Самара|      6687|
|Санкт-Петербург|      5293|
|     Красноярск|      5232|
| Ростов-на-Дону|      4956|
|   Екатеринбург|      4775|
|         Казань|      4773|
|    Новосибирск|      4498|
|    Калининград|      4431|
|        Воронеж|      4304|
+---------------+----------+
only showing top 10 rows
```
6.1. Здания с максимальной площадью в рамках каждой области:
```
+--------------------+----------+
|              region|max_square|
+--------------------+----------+
|      Омская область| 3652010.0|
|              Москва|  883057.4|
|                ХМАО|  646910.0|
|   Красноярский край|  452520.0|
|    Амурская область|  429720.0|
|   Кировская область|  313165.6|
|   Самарская область|  259491.0|
| Воронежская область|  198476.7|
|Удмуртская Респуб...|  197757.0|
|Республика Татарстан|  194618.0|
|     Санкт-Петербург| 187955.11|
|Северо-Западный ф...|  181937.4|
|  Московская область|  145000.0|
|  Пензенская область|  122261.1|
|   Иркутская область|  121168.9|
|  Ростовская область|  107113.9|
|    Липецкая область|  100071.4|
|  Смоленская область|   97496.0|
|Ленинградская обл...|   91195.9|
|      Алтайский край|   88871.7|
+--------------------+----------+
only showing top 20 rows
```
6.2. Здания с минимальной площадью в рамках каждой области:
```
+--------------------+----------+
|              region|min_square|
+--------------------+----------+
|  Тамбовская область|       2.0|
|  Курганская область|      2.17|
| Республика Марий Эл|      2.18|
|Кабардино-Балкарс...|       2.2|
|  Республика Карелия|      2.66|
|     Приморский край|       2.8|
| Ульяновская область|      2.88|
|   Кировская область|       2.9|
|Калининградская о...|       3.0|
| Сахалинская область|       3.0|
|Владимирская область|      3.01|
|Нижегородская обл...|      3.04|
|Республика Саха (...|      3.06|
|      Алтайский край|      3.26|
|              Москва|      3.65|
|Свердловская область|       4.0|
| Ставропольский край|      4.13|
| Вологодская область|      4.35|
|  Московская область|      4.84|
|Оренбургская область|       4.9|
+--------------------+----------+
only showing top 20 rows
```
Датафрейм с новым полем 'group_year':
```
+--------+---------+---------+----------------+--------+----------+-------------------+--------------------+--------------------+--------------------+-------------------+--------------------+-------------+----------+
|house_id| latitude|longitude|maintenance_year|  square|population|             region|       locality_name|             address|        full_address|communal_service_id|         description|modify_square|group_year|
+--------+---------+---------+----------------+--------+----------+-------------------+--------------------+--------------------+--------------------+-------------------+--------------------+-------------+----------+
|      60|44.148598|43.473896|            1968|  997.00|        50|Ставропольский край|          Георгиевск| ул. Горийская, д. 6|Ставропольский кр...|               12.0|Жилой дом в Георг...|        997.0|        96|
|      81|44.123013|43.636555|            1976|  872.10|        42|Ставропольский край|поселок Нижнезоль...|п. Нижнезольский,...|Ставропольский кр...|               14.0|Жилой дом в , по ...|        872.1|        97|
|     260|44.628216| 44.13441|            1979|7 354.40|       167|Ставропольский край|          Буденновск|      мкр. 8-й, д. 4|Ставропольский кр...|               23.0|Жилой дом в Буден...|       7354.4|        97|
|     440| 44.15409|43.474525|            1975|1 195.20|        52|Ставропольский край|          Георгиевск|ул. Лермонтова, д...|Ставропольский кр...|               48.0|Жилой дом в Георг...|       1195.2|        97|
|     936| 44.63441|41.948772|            1979|3 105.30|       112|Ставропольский край|        Невинномысск|ул. 3 Интернацион...|Ставропольский кр...|              119.0|Жилой дом в Невин...|       3105.3|        97|
|    1420|45.071445|41.981087|            1983|5 622.60|       337|Ставропольский край|          Ставрополь| ул. Трунова, д. 103|Ставропольский кр...|              202.0|Жилой дом в Ставр...|       5622.6|        98|
|    2055|45.034763| 41.93906|            1964|5 062.90|       217|Ставропольский край|          Ставрополь|ул. Доваторцев, д. 5|Ставропольский кр...|              231.0|Жилой дом в Ставр...|       5062.9|        96|
|    2364| 45.03581| 41.94782|            1967|2 805.20|        99|Ставропольский край|          Ставрополь|ул. Мира, д. 367,...|Ставропольский кр...|              247.0|Жилой дом в Ставр...|       2805.2|        96|
|    2426|  45.0406| 41.94711|            1966|3 864.00|       177|Ставропольский край|          Ставрополь|ул. Дзержинского,...|Ставропольский кр...|              249.0|Жилой дом в Ставр...|       3864.0|        96|
|    2456|45.037296|  41.9352|            1964|1 485.90|        65|Ставропольский край|          Ставрополь| ул. Семашко, д. 6/2|Ставропольский кр...|              249.0|Жилой дом в Ставр...|       1485.9|        96|
|    2788| 44.99708|41.917385|            1996|1 856.20|        69|Ставропольский край|          Ставрополь|ул. 45 Параллель,...|Ставропольский кр...|              420.0|Жилой дом в Ставр...|       1856.2|        99|
|    3097| 44.04647| 42.85387|            1962|  695.20|        27|Ставропольский край|           Ессентуки|ул. Вокзальная, д...|Ставропольский кр...|              483.0|Жилой дом в Ессен...|        695.2|        96|
|    3134|44.019768| 42.75847|            1984|4 674.60|       263|Ставропольский край|поселок Ясная Поляна|п. Ясная Поляна, ...|Ставропольский кр...|              484.0|Жилой дом в , по ...|       4674.6|        98|
|    3167|  44.0506|42.884872|            2000|9 800.70|       153|Ставропольский край|           Ессентуки|ул. Новопятигорск...|Ставропольский кр...|              496.0|Жилой дом в Ессен...|       9800.7|       100|
|    3184|  44.0383|42.868385|            1959|  390.70|        24|Ставропольский край|           Ессентуки|ул. Октябрьская, ...|Ставропольский кр...|              513.0|Жилой дом в Ессен...|        390.7|        95|
|    3250|44.146538|43.009575|            1966|2 491.49|        79|Ставропольский край|        Железноводск|ул. Строителей, д...|Ставропольский кр...|              534.0|Жилой дом в Желез...|      2491.49|        96|
|    3257| 44.14473| 43.00626|            1977|1 260.10|        40|Ставропольский край|        Железноводск| ул. К.Маркса, д. 60|Ставропольский кр...|              535.0|Жилой дом в Желез...|       1260.1|        97|
|    3667| 43.90523|42.716778|            1959|  497.00|        23|Ставропольский край|          Кисловодск|ул. Седлогорская,...|Ставропольский кр...|              584.0|Жилой дом в Кисло...|        497.0|        95|
|    3870|44.059784| 43.05354|            1970|2 803.60|       113|Ставропольский край|           Пятигорск|ул. Московская, д...|Ставропольский кр...|              690.0|Жилой дом в Пятиг...|       2803.6|        97|
|    3973|44.034786|43.072117|            1917|  168.50|        12|Ставропольский край|           Пятигорск|ул. Дегтярева, д. 58|Ставропольский кр...|              696.0|Жилой дом в Пятиг...|        168.5|        91|
+--------+---------+---------+----------------+--------+----------+-------------------+--------------------+--------------------+--------------------+-------------------+--------------------+-------------+----------+
only showing top 20 rows
```
7. Определим количество зданий по десятилетиям:
```
+--------------------+--------------------+------------+
|min_maintenance_year|max_maintenance_year|count_houses|
+--------------------+--------------------+------------+
|                1960|                1969|       95261|
|                1970|                1979|       85165|
|                1980|                1989|       79316|
|                1950|                1959|       68520|
|                1990|                1999|       37403|
|                2000|                2009|       19910|
|                1940|                1949|       15710|
|                1910|                1919|       10693|
|                2010|                2019|        9990|
|                1930|                1939|        9840|
|                1920|                1929|        3764|
|                1900|                1909|        2100|
|                1890|                1899|        1051|
|                1880|                1889|         602|
|                1870|                1879|         326|
|                1860|                1869|         144|
|                1850|                1859|         108|
|                1830|                1839|          61|
|                1840|                1849|          59|
|                1820|                1829|          41|
+--------------------+--------------------+------------+
only showing top 20 rows
```
11. Выводим топ 25 домов из таблицы houses_data в ClickHouse, у которых площадь больше 60 кв.м:
```
+--------------------+------------+
|        full_address|      square|
+--------------------+------------+
|Омская область, г...|3 652 010.00|
|Москва, ул. Стары...|  883 057.36|
|Ханты-Мансийский ...|  646 910.00|
|Красноярский край...|  452 520.00|
|Красноярский край...|  448 666.00|
|Красноярский край...|  441 713.00|
|Красноярский край...|  441 350.00|
|Амурская область,...|  429 720.00|
|Москва, пер. Трех...|  383 408.00|
|Москва, ул. Подол...|  335 259.00|
|Кировская область...|  313 165.60|
|Красноярский край...|  270 929.00|
|Самарская область...|  259 491.00|
|Москва, наб. Акад...|  214 075.50|
|Красноярский край...|  212 432.00|
|Москва, б-р. Марш...|  202 347.10|
|Москва, ул. Марша...|  202 034.00|
|Воронежская облас...|  198 476.70|
|Москва, ш. Хороше...|  198 275.30|
|Респ. Удмуртская,...|  197 757.00|
|Респ. Татарстан, ...|  194 618.00|
|Респ. Татарстан, ...|  188 873.30|
|г. Санкт-Петербур...|  187 955.11|
|г. Санкт-Петербур...|  181 937.40|
|Красноярский край...|  150 655.00|
+--------------------+------------+
only showing top 25 rows
```
